function [SamakTe SamakRF] = BuildSamakRF(varargin)

p = inputParser;            
p.addParameter('PixelList',1);
p.parse(varargin{:});
PixelList    = p.Results.PixelList;

% Inputs
PixelWiseBa = [0.00063209  0.00063205  0.00063209  0.00063213  0.00063194  0.00063188  0.00063184  0.00063182  0.00063182  0.00063185   0.0006319  0.00063195    0.000632  0.00063202  0.00063202  0.00063199  0.00063167   0.0006316  0.00063155  0.00063153  0.00063156  0.00063161  0.00063169  0.00063176  0.00063182  0.00063183   0.0006318  0.00063174  0.00063149   0.0006314  0.00063133  0.00063129   0.0006313  0.00063135  0.00063142  0.00063151  0.00063159  0.00063163  0.00063162  0.00063157  0.00063124  0.00063115  0.00063109  0.00063107   0.0006311  0.00063117  0.00063126  0.00063136  0.00063143  0.00063144  0.00063141  0.00063134  0.00063111  0.00063101  0.00063093  0.00063089  0.00063089  0.00063094  0.00063103  0.00063113  0.00063122  0.00063126  0.00063126   0.0006312  0.00063089   0.0006308  0.00063074  0.00063071  0.00063074  0.00063081  0.00063091  0.00063101  0.00063108   0.0006311  0.00063107  0.00063099   0.0006308   0.0006307  0.00063062  0.00063058  0.00063058  0.00063062   0.0006307  0.00063081  0.00063089  0.00063095  0.00063094  0.00063089  0.00063062  0.00063053  0.00063047  0.00063045  0.00063047  0.00063053  0.00063062  0.00063072  0.00063079  0.00063081  0.00063078  0.00063071  0.00063056  0.00063047   0.0006304  0.00063036  0.00063036  0.00063039  0.00063046  0.00063055  0.00063064  0.00063069  0.00063069  0.00063064  0.00063043  0.00063036  0.00063031  0.00063028  0.00063029  0.00063034  0.00063041  0.00063049  0.00063056  0.00063059  0.00063057   0.0006305   0.0006304  0.00063033  0.00063028  0.00063024  0.00063023  0.00063025   0.0006303  0.00063037  0.00063044  0.00063049   0.0006305  0.00063046  0.00063032  0.00063027  0.00063023  0.00063021   0.0006302  0.00063023  0.00063028  0.00063034   0.0006304  0.00063043  0.00063042  0.00063037];
% Ba

%% Create TBD
% Default
opt_calc = {...
    'nTeBinningFactor',100};

opt_katrin = {...
    'TDMode', 'Read',...
    'TD','MasterRFqU18545',...
    'TimeSec',7200,...
    'mnuSq_i',0};

opt_wgts = {...
    'ELossFlag','KatrinD2',...
    'NIS',7,...
    'WGTS_MolFrac_TT',.95,...
    'WGTS_MolFrac_DT',.04,...
    'WGTS_MolFrac_HT',.01,...
    'WGTS_FTR_cm',4.1,...
    'WGTS_CD_MolPerCm2',1.1e17,...
    'WGTS_B_T',2.52,...
    'WGTS_Temp',30,...
    'ISCS','Theory',...
    'recomputeRF','ON',...
    'UseParallelRF','ON'};

opt_mace = {...
    'MACE_Bmax_T',4.23,...
           };

opt_wgtsmace = {...
    'KTFFlag','WGTSMACE'};

opt_integration = {'IStype','SIMPFAST'};

counter=0;
for pix=PixelList
    counter=counter+1;
    opt_fpd = {...
        'FPD_Segmentation','OFF',...
        'FPD_PixList',pix,...
        'MACE_Ba_T',PixelWiseBa(pix)};
    
    SFR = TBD(...
        opt_calc{:},...
        opt_katrin{:},...
        opt_wgts{:},...
        opt_mace{:},...
        opt_fpd{:},...
        opt_wgtsmace{:},...
        opt_integration{:});
    
    SamakTe = SFR.Te;
    SamakRF(:,:,counter) = (SFR.RF)';
end

%save('SamakRF.mat','SamakTe','SamakRF');
save('SamakRFqU18545.mat','SamakTe','SamakRF');
%save('SamakRFqU18545_NoSynch.mat','SamakTe','SamakRF');

%% Extract Response Function
[teBins qUbins] = size(SFR.RF); 
fprintf('Samak RF: teBins=%.0f qUbins=%.0f\n',teBins,qUbins);
SFR.DisplayWGTSMACEInfo

% Plot Response Function
fign = figure('Name','Samak','NumberTitle','off','rend','painters','pos',[10 10 1200 600]);
maintitle=sprintf('Samak Response Function - \\rho.d = %.4g mol/cm^2 - Bs = %.2f T - Ba = %.3g G',...
    1.1e17,2.52,6.3);
a=annotation('textbox', [0 0.9 1 0.1], ...
    'String', maintitle, ...
    'EdgeColor', 'none', ...
    'HorizontalAlignment', 'center');
a.FontSize=20;a.FontWeight='bold';
h = plot(SFR.Te,SFR.RF(:,:),'LineWidth',2);
set(gca, 'YScale', 'lin');
xlabel('T_e (eV)','FontSize',18);
ylabel('transmission','FontSize',18);
grid on
PrettyFigureFormat
set(gca,'FontSize',18);

end